#!/bin/sh
#
# Combined pre-commit hook: bd + cargo-husky
#

# Part 1: bd (beads) pre-commit hook
# Ensures that any pending bd issue changes are flushed to
# .beads/issues.jsonl before the commit is created

# Check if bd is available
if command -v bd >/dev/null 2>&1; then
    # Check if we're in a bd workspace
    if [ -d .beads ]; then
        # Flush pending changes to JSONL
        # Use --flush-only to skip git operations (we're already in a git hook)
        # Suppress output unless there's an error
        if ! bd sync --flush-only >/dev/null 2>&1; then
            echo "Error: Failed to flush bd changes to JSONL" >&2
            echo "Run 'bd sync --flush-only' manually to diagnose" >&2
            exit 1
        fi

        # If the JSONL file was modified, stage it
        if [ -f .beads/issues.jsonl ]; then
            git add .beads/issues.jsonl 2>/dev/null || true
        fi
    fi
fi

# Part 2: cargo-husky pre-commit hook
# Runs format check, lint, and tests before allowing commit

set -e

echo "Running pre-commit checks..."

# Check formatting
echo "→ Checking code formatting..."
cargo fmt --all -- --check

# Run clippy
echo "→ Running clippy..."
cargo clippy --all-targets --all-features -- -D warnings

# Run tests
echo "→ Running tests..."
cargo test --all-features

echo "✓ All pre-commit checks passed!"
